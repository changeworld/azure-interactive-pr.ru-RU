---
title: включение файла
description: включение файла
services: functions
author: ggailey777
manager: jeconnoc
ms.service: multiple
ms.topic: include
ms.date: 10/12/2018
ms.author: glenga
ms.custom: include file
ms.openlocfilehash: 3779c2e130afa7ee8d5879f30a924e258b7a41e9
ms.sourcegitcommit: fdb43556b8dcf67cb39c18e532b5fab7ac53eaee
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/15/2018
ms.locfileid: "49315982"
---
Приложение, которое вы создаете, представляет собой галерею фотографий. В нем используется клиентский код JavaScript, чтобы вызывать API-интерфейсы для отправки и вывода изображений. В этом модуле вы создадите API с помощью бессерверной функции, которая генерирует временный URL-адрес для отправки изображения. Веб-приложение использует сгенерированный URL-адрес для отправки изображения в хранилище BLOB-объектов с помощью [REST API хранилища BLOB-объектов](https://docs.microsoft.com/rest/api/storageservices/blob-service-rest-api).

## <a name="create-a-blob-storage-container-for-images"></a>Создание контейнера хранилища BLOB-объектов для изображений

Приложению требуется отдельный контейнер с хранилищем для отправки и размещения изображений.

1. Убедитесь, что окно Cloud Shell (Bash) открыто. Если вы уже вышли, выберите **Enter focus mode** (Перейти в режим фокусировки), чтобы открыть окно Cloud Shell.

1.  Создайте контейнер с именем **images** в своей учетной записи хранения с общим доступом ко всем большим двоичным объектам.

    ```azurecli
    az storage container create -n images --account-name <storage account name> --public-access blob
    ```

## <a name="create-an-azure-function-app"></a>Создание приложения-функции Azure

Решение "Функции Azure" — это служба для выполнения бессерверных функций. Бессерверные функции могут активироваться (вызываться) событиями, такими как HTTP-запрос или создание большого двоичного объекта в контейнере хранилища.

Приложение-функция Azure — это контейнер для одной или нескольких бессерверных функций.

Создайте приложение-функцию Azure с уникальным именем в группе ресурсов **first-serverless-app**, которую вы создали ранее. Для приложений-функций требуется учетная запись хранения. При работе с этим руководством используйте существующую учетную запись хранения.

```azurecli
az functionapp create -n <function app name> -g first-serverless-app -s <storage account name> -c westcentralus
```

## <a name="configure-the-function-app"></a>Настройка приложения-функции

Для приложения-функции, используемого в этом руководстве, требуется среда выполнения Функций версии 1.x. Задайте значение `~1` для параметра `FUNCTIONS_EXTENSION_VERSION`, чтобы закрепить приложение-функцию в последней версии 1.x. Задайте параметры приложения с помощью команды [az functionapp config appsettings set](https://docs.microsoft.com/cli/azure/functionapp/config/appsettings#set).

В следующей команде Azure CLI <app_name> — это имя приложения-функции.

```azurecli
az functionapp config appsettings set --name <function app name> --g first-serverless-app --settings FUNCTIONS_EXTENSION_VERSION=~1
```

## <a name="create-an-http-triggered-serverless-function"></a>Создание бессерверной функции, активируемой HTTP-запросом

Веб-приложение коллекции фотографий выполняет HTTP-запрос к бессерверной функции, чтобы создать временный URL-адрес для безопасной отправки изображений в хранилище BLOB-объектов. Функция активируется HTTP-запросом и использует пакет SDK для службы хранилища Azure, чтобы создать и вернуть защищенный URL-адрес.

1. Когда приложение-функция будет создано, найдите его на портале Azure с помощью поля поиска и щелкните, чтобы открыть.

    ![Открытие приложения-функции](media/functions-first-serverless-web-app/2-search-function-app.png)

1. В окне приложения-функции наведите указатель мыши на элемент **Функции** в области навигации слева и нажмите кнопку **+**, чтобы приступить к созданию бессерверной функции.

    ![Создание функции](media/functions-first-serverless-web-app/2-new-function.png)

1. Щелкните **Пользовательская функция**, чтобы просмотреть список шаблонов функций.

1. Найдите шаблон **HttpTrigger** и выберите язык (C# или JavaScript).

1. Задайте указанные ниже значения, чтобы создать функцию, которая генерирует URL-адрес для отправки BLOB-объектов.

    | Параметр      |  Рекомендуемое значение   | ОПИСАНИЕ                                        |
    | --- | --- | ---|
    | **Язык** | C# или JavaScript | Выберите нужный язык. |
    | **Имя функции** | GetUploadUrl | Введите это имя именно так, как показано, чтобы приложение смогло обнаружить функцию. |
    | **Уровень авторизации** | Анонимные | Предоставьте общий доступ к функции. |

    ![Ввод параметров для новой функции, активируемой HTTP-запросом](media/functions-first-serverless-web-app/2-new-function-httptrigger.png)

1. Щелкните **Создать**, чтобы создать функцию.

1. **C#** 

    1. Когда отобразится исходный код функции, замените содержимое файла **run.csx** содержимым из репозитория [**csharp/GetUploadUrl/run.csx**](https://raw.githubusercontent.com/Azure-Samples/functions-first-serverless-web-application/master/csharp/GetUploadUrl/run.csx).

1. **JavaScript** 

    1. (JavaScript) Для этой функции требуется пакет `azure-storage` из npm, чтобы сгенерировать токен подписанного URL-адреса (SAS), необходимый для создания защищенного URL-адреса. Чтобы установить пакет npm, щелкните имя приложения-функции в области навигации слева и выберите **Функции платформы**.

    1. (JavaScript) Чтобы открыть окно консоли, щелкните **Консоль**.

        ![Открытие окна консоли](media/functions-first-serverless-web-app/2-open-console.jpg)

    1. (JavaScript) Убедитесь, что в качестве текущего каталога используется **d:\home\site\wwwroot**, выполнив команду `cd d:\home\site\wwwroot`.

    1. (JavaScript) Выполните команду `npm init -y`, чтобы создать пустой файл **package.json**.

    1. (JavaScript) В консоли выполните команду `npm install --save azure-storage`, чтобы установить пакет и сохранить его в файле **package.json**. Выполнение операции может занять одну-две минуты.

    1. (JavaScript) Щелкните имя функции (**GetUploadUrl**) в области навигации слева, чтобы открыть окно с ее кодом. Замените содержимое файла **index.js** содержимым из репозитория [**javascript/GetUploadUrl/index.js**](https://raw.githubusercontent.com/Azure-Samples/functions-first-serverless-web-application/master/javascript/GetUploadUrl/index.js).
    
        ![Файл index.js после обновления](media/functions-first-serverless-web-app/2-paste-js.jpg)

1. Щелкните **Журналы** под окном кода, чтобы развернуть панель журналов.

1. Выберите команду **Сохранить**. Просмотрите записи на панели журналов и проверьте, успешно ли скомпилирована функция.

Функция создает так называемый подписанный URL-адрес (SAS), который используется для отправки файла в хранилище BLOB-объектов. URL-адрес SAS действителен в течение короткого периода времени и позволяет отправить только один файл. Дополнительные сведения об [использовании подписанных URL-адресов](https://docs.microsoft.com/azure/storage/common/storage-dotnet-shared-access-signature-part-1) см. в документации по хранилищу BLOB-объектов.


## <a name="add-an-environment-variable-for-the-storage-connection-string"></a>Добавление переменной среды для строки подключения к хранилищу

Чтобы только что созданная функция могла сгенерировать URL-адрес SAS, ей требуется строка подключения для учетной записи хранения. Чтобы не указывать строку подключения прямо в тексте функции, эту строку можно сохранить как параметр приложения. Параметры приложения доступны в виде переменных среды для всех функций в приложении-функции.

1. В Cloud Shell запросите строку подключения для учетной записи хранения и сохраните ее в переменной bash с именем **STORAGE_CONNECTION_STRING**.

    ```azurecli
    export STORAGE_CONNECTION_STRING=$(az storage account show-connection-string -n <storage account name> -g first-serverless-app --query "connectionString" --output tsv)
    ```

    Убедитесь, что эта переменная успешно задана.

    ```azurecli
    echo $STORAGE_CONNECTION_STRING
    ```

1. Создайте параметр приложения с именем **AZURE_STORAGE_CONNECTION_STRING**, используя значение, сохраненное на предыдущем шаге.

    ```azurecli
    az functionapp config appsettings set -n <function app name> -g first-serverless-app --settings AZURE_STORAGE_CONNECTION_STRING=$STORAGE_CONNECTION_STRING -o table
    ```

    Убедитесь, что в выходных данных команды содержится новый параметр приложения с правильным значением.


## <a name="test-the-serverless-function"></a>Тестирование бессерверной функции

На портале Azure предоставлены встроенные средства, которые позволяют не только создавать и редактировать функции, но и тестировать их.

1. Чтобы проверить бессерверную функцию, которая активируется HTTP-запросом, щелкните вкладку **Тест** в правой части окна кода для развертывания области тестирования.

1. Измените **метод HTTP** на **GET**.

1. В разделе **Запрос** щелкните *Добавить параметр*\*, чтобы добавить следующий параметр:

    | name      |  value   | 
    | --- | --- |
    | filename | image1.jpg |

1. В области тестирования нажмите кнопку **Запуск**, чтобы отправить HTTP-запрос к функции.

1. Функция возвращает выходные данные с URL-адресом для отправки. Сведения о выполнении функции отображаются в области журналов.

    ![Область журналов со сведениями о том, что функция выполнена успешно](media/functions-first-serverless-web-app/2-test-function.png)


## <a name="configure-cors-in-the-function-app"></a>Настройка CORS в приложении-функции

Так как внешний интерфейс приложения размещен в хранилище BLOB-объектов, для него используется не такое доменное имя, как для приложения-функции Azure. Чтобы из клиентского кода JavaScript успешно вызывалась функция, которую вы только что создали, нужно настроить CORS (предоставление общего доступа к ресурсам независимо от источника) для приложения-функции.

1. На панели навигации слева в окне приложения-функции щелкните имя приложения-функции.

1. Выберите **Функции платформы**, чтобы просмотреть список дополнительных функций.

1. В разделе **API** щелкните **CORS**.

    ![Выбор варианта CORS](media/functions-first-serverless-web-app/2-open-cors.jpg)

1. Добавьте допустимый источник для URL-адреса приложения из предыдущего модуля без символа **/** в конце (например, `https://firstserverlessweb.z4.web.core.windows.net`).

    ![Снимок экрана с параметрами CORS, на котором показано добавление URL-адреса бессерверного веб-приложения](media/functions-first-serverless-web-app/2-add-cors.png)

1. Выберите команду **Сохранить**.

1. C#

   1. (C#) Вернитесь к функции `GetUploadUrl` и выберите вкладку **Интегрировать**.

   1. (C#) В разделе "Выбранные методы HTTP" щелкните **OPTIONS**.

      Для методов **GET**, **POST** и **OPTIONS** должны быть установлены флажки. Для CORS используется метод OPTIONS, который не выбран по умолчанию для функций C#.  

   1. (C#) Щелкните **Сохранить**.

1. Оставаясь на портале, перейдите к приложению-функции, выберите вкладку **Обзор** и щелкните **Перезапустить**, чтобы изменения для CORS вступили в силу.

## <a name="configure-cors-in-the-storage-account"></a>Настройка CORS в учетной записи хранения

Так как для отправки файлов приложение выполняет клиентские вызовы JavaScript к хранилищу BLOB-объектов, нужно также настроить учетную запись хранения для CORS.

1. Чтобы разрешить отправку файлов в учетную запись хранения из всех источников, выполните приведенную ниже команду.

    ```azurecli
    az storage cors add --methods OPTIONS PUT --origins '*' --exposed-headers '*' --allowed-headers '*' --services b --account-name <storage account name>
    ```


## <a name="modify-the-web-app-to-upload-images"></a>Изменение веб-приложения для отправки изображений

Веб-приложение извлекает параметры из файла с именем **settings.js**. На следующих этапах вы с помощью Cloud Shell создадите файл, а затем укажете `window.apiBaseUrl` для URL-адреса приложения-функции и `window.blobBaseUrl` для URL-адреса конечной точки хранилища BLOB-объектов Azure.

1. В Cloud Shell убедитесь, что в качестве текущего каталога используется папка **www/dist**.

    ```azurecli
    cd ~/functions-first-serverless-web-application/www/dist
    ```

1. Запросите URL-адрес приложения-функции и сохраните его в переменной bash с именем **FUNCTION_APP_URL**.

    ```azurecli
    export FUNCTION_APP_URL="https://"$(az functionapp show -n <function app name> -g first-serverless-app --query "defaultHostName" --output tsv)
    ```

    Убедитесь, что переменная указана правильно.

    ```azurecli
    echo $FUNCTION_APP_URL
    ```

1. Чтобы задать базовый URI для вызовов API к своему приложению-функции, создайте файл **settings.js** и добавьте URL-адрес приложения-функции, как показано ниже.

    `window.apiBaseUrl = 'https://fnapp@lab.GlobalLabInstanceId.azurewebsites.net'`

    Чтобы внести изменения, можно выполнить указанную далее команду или использовать редактор командной строки, например VIM.

    ```azurecli
    echo "window.apiBaseUrl = '$FUNCTION_APP_URL'" > settings.js
    ```

    Убедитесь, что файл успешно записан.

    ```azurecli
    cat settings.js
    ```

1. Запросите базовый URL-адрес хранилища BLOB-объектов и сохраните его в переменной bash с именем **BLOB_BASE_URL**.

    ```azurecli
    export BLOB_BASE_URL=$(az storage account show -n <storage account name> -g first-serverless-app --query primaryEndpoints.blob -o tsv | sed 's/\/$//')
    ```

    Убедитесь, что переменная указана правильно.

    ```azurecli
    echo $BLOB_BASE_URL
    ```

1. Чтобы задать базовый URI для вызовов API к своему приложению-функции, добавьте URL-адрес хранилища в файл **settings.js**, как в приведенном ниже примере строки кода.

    `window.blobBaseUrl = 'https://mystorage.blob.core.windows.net'`

    Чтобы внести изменения, можно выполнить указанную далее команду или использовать редактор командной строки, например VIM.

    ```azurecli
    echo "window.blobBaseUrl = '$BLOB_BASE_URL'" >> settings.js
    ```

    Убедитесь, что файл успешно записан и теперь содержит две строки.

    ```azurecli
    cat settings.js
    ```

1. Отправьте файл в хранилище BLOB-объектов.

    ```azurecli
    az storage blob upload -c \$web --account-name <storage account name> -f settings.js -n settings.js
    ```


## <a name="test-the-web-application"></a>Тестирование веб-приложения

На этом этапе приложение коллекции может отправлять изображения в хранилище BLOB-объектов, но еще не может выводить изображения. Приложение попытается вызвать еще не существующую функцию `GetImages`, которую вы создадите в следующем модуле. Этот вызов завершится ошибкой и веб-страница перестанет отвечать на запросы на этапе анализа, но выбранное изображение успешно отправится.

Убедитесь в том, что изображение успешно отправлено, проверив содержимое контейнера **images** на портале Azure.

1. В окне браузера перейдите к приложению. Выберите файл изображения и отправьте его. Отправка завершится, но, так как мы еще не добавили возможность выводить изображения, в приложении не отобразится отправленная фотография (веб-страница перестанет отвечать на запросы на этапе анализа изображения; вы исправите это позже).

1. В Cloud Shell проверьте, отправлено ли изображение в контейнер **images**.

    ```azurecli
    az storage blob list --account-name <storage account name> -c images -o table
    ```

1. Прежде чем перейти к следующему руководству, удалите все файлы в контейнере **images**.

    ```azurecli
    az storage blob delete-batch -s images --account-name <storage account name>
    ```


## <a name="summary"></a>Сводка

В этом модуле вы создали приложение-функцию Azure и узнали, как с помощью бессерверных функций разрешить веб-приложению отправлять изображения в хранилище BLOB-объектов. Далее вы научитесь создавать эскизы для отправленных изображений с помощью бессерверной функции, активируемой большим двоичным объектом.
